name: Lint Code
on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
jobs:
  detect:
    name: Detect changed language directories
    runs-on: self-hosted
    outputs:
      go: ${{ steps.changes.outputs.go }}
      rust: ${{ steps.changes.outputs.rust }}
      nodejs: ${{ steps.changes.outputs.nodejs }}
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 2

    - name: Filter changed paths
      id: changes
      uses: dorny/paths-filter@v2
      with:
        filters: |
          go:
            - 'go/**'
          rust:
            - 'rust/**'
          nodejs:
            - 'nodejs/**'

  lint-go:
    needs: detect
    if: needs.detect.outputs.go == 'true'
    runs-on: self-hosted
    steps:
    - uses: actions/checkout@v4
    - uses: golangci/golangci-lint-action@v3
      with:
        working-directory: go

  lint-rust:
    needs: detect
    if: needs.detect.outputs.rust == 'true'
    runs-on: self-hosted
    steps:
    - uses: actions/checkout@v4
    - uses: dtolnay/rust-toolchain@stable
    - run: cargo clippy --manifest-path rust/Cargo.toml -- -D warnings

  lint-nodejs:
    needs: detect
    if: needs.detect.outputs.nodejs == 'true'
    runs-on: self-hosted
    steps:
    - uses: actions/checkout@v4
    - uses: actions/setup-node@v4
      with:
        node-version: '18'
    - run: cd nodejs && npm install && npx eslint src/